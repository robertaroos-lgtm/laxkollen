<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L√§xkollen</title>

  <!-- PWA: manifest + f√§rg + iOS-webapp -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    /* Safe area (iPhone helsk√§rm) */
    :root { --safe-bottom: env(safe-area-inset-bottom); }
    body { font-family: sans-serif; background:#f6f7fb; margin:0; color:#111827; padding-bottom:var(--safe-bottom, 0); }
    input, select, button, textarea { font-family: inherit; }
    input[type="date"]{ font-family: inherit; }

    .app { max-width: 1040px; margin:40px auto; padding:24px; background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    h1 { margin:0 0 12px; }

    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .topbar .spacer { flex:1; }

    .actions-row { display:flex; justify-content:flex-start; gap:8px; margin:0 0 12px; }

    select, input[type="text"], input[type="date"], input[type="number"] {
      padding:10px; font-size:14px; border:1px solid #ddd; border-radius:8px; background:#fff; color:#000;
    }
    input[disabled]{ background:#f3f4f6; color:#6b7280; }
    button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; }
    .primary { background:#6366f1; color:#fff; }
    .primary[disabled]{ opacity:.6; cursor:not-allowed; }
    .ghost { background:#eef0f6; }

    .summary { display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:12px; margin:12px 0 16px; }
    .card { display:flex; flex-direction:column; gap:6px; padding:12px; border:1px solid #eef0f5; background:#fafbff; border-radius:12px; cursor:pointer; transition:transform .05s, box-shadow .15s; }
    .card:hover { box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .card:active { transform:translateY(1px); }
    .card .title { display:flex; align-items:center; gap:8px; font-weight:700; }
    .card .kpi { display:flex; gap:10px; font-size:13px; color:#374151; }
    .pill { padding:2px 8px; border-radius:999px; background:#eef0f6; font-size:12px; }
    .active-pill { background:#6366f1; color:#fff; }
    .card.selected { background:#6366f1; color:#fff; }
    .card.selected .pill { background: rgba(255,255,255,0.2); color:#fff; font-weight:bold; }

    @media (max-width: 900px) { .summary { grid-template-columns: repeat(3, minmax(180px, 1fr)); } }
    @media (max-width: 700px) { .summary { grid-template-columns: repeat(2, minmax(160px, 1fr)); } }
    @media (max-width: 460px) { .summary { grid-template-columns: 1fr; } }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .row.compact-gap { gap:4px; }

    .field { display:flex; flex-direction:column; flex:1; min-width:160px; }
    .field label { font-size:13px; font-weight:600; margin-bottom:4px; color:#374151; }

    /* PROV-f√§lt: kompakt */
    .field.prov { flex:0 0 auto; min-width:44px; width:44px; }
    .field.prov label { margin-bottom:2px; }
    .field.prov .checkline { display:flex; align-items:center; justify-content:flex-start; gap:0; padding:0; margin:0; }
    .field.prov input[type="checkbox"]{ width:18px; height:18px; margin:0; }

    .chip { background:#eef0f6; padding:6px 12px; border-radius:999px; cursor:pointer; user-select:none; }
    .chip.active { background:#6366f1; color:#fff; }

    .totals { margin:8px 0 8px; font-size:14px; color:#374151; background:#f8fafc; border:1px solid #eef0f5; border-radius:10px; padding:8px 12px; }

    /* Lista */
    ul { list-style:none; padding:0; margin:0; }
    li { 
      display:grid; 
      grid-template-columns: 32px 110px 1fr auto auto; 
      gap:12px; align-items:center;
      border:1px solid #eee; border-radius:12px; background:#fafbff; padding:12px; margin-bottom:8px; 
    }

    li.done .text { text-decoration:line-through; color:#6b7280; }
    li.overdue { border-color:#fecaca; }
    li.today { border-color:#bfdbfe; }
    li.exam .text { font-weight:700; }

    .text { color:#111827; }
    .meta-line { font-size:13px; color:#555; }
    .icon-btn { border:0; border-radius:6px; background:#eef0f6; width:32px; height:32px; cursor:pointer; }
    .danger { background:#fee2e2; }
    .danger:hover { background:#fecaca; }

    .progress-badge { font-size:12px; background:#eef0f6; border-radius:999px; padding:2px 8px; text-align:center; display:inline-block; min-width:60px; }
    .ghost-cell { visibility:hidden; }

    .due-badge { font-size:12px; border-radius:999px; padding:2px 8px; background:#eef0f6; }
    .due-badge.today { background:#dbeafe; color:#1e40af; font-weight:600; }
    .due-badge.overdue { background:#fee2e2; color:#991b1b; font-weight:600; }
    .exam-badge { font-size:11px; font-weight:800; letter-spacing:.3px; color:#7c2d12;
      background:#fde68a; border:1px solid #f59e0b; border-radius:6px; padding:2px 6px; white-space:nowrap; }

    /* Modal (b√•de ‚ÄúHantera barn‚Äù och ‚ÄúRedigera‚Äù) */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .modal { width:min(820px, 100%); background:#fff; border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); max-height:90vh; overflow:auto; }
    .modal h2 { margin:0 0 8px; }

    /* Hantera barn ‚Äì chipsgrupper */
    .child-row { display:flex; gap:10px; align-items:flex-start; flex-direction:column; margin:8px 0; padding:10px; border:1px solid #eef0f5; border-radius:12px; background:#fafbff; }
    .subjects-collection { display:flex; flex-direction:column; gap:8px; width:100%; }
    .subjects-group { display:flex; flex-direction:column; gap:4px; }
    .group-header { font-weight:700; color:#374151; }
    .subject-row { display:flex; gap:6px; overflow-x:auto; white-space:nowrap; padding-bottom:4px; }
    .sub-chip { display:inline-flex; align-items:center; gap:6px; background:#eef0f6; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; font-size:12px; cursor:pointer; user-select:none; }
    .sub-chip.active { background:#6366f1; color:#fff; border-color:#6366f1; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .note { font-size:13px; color:#6b7280; }
    .danger-text { color:#b91c1c; }

    [hidden] { display:none !important; }

    .toast{
      position:fixed; left:50%; bottom:16px;
      transform:translateX(-50%) translateY(20px);
      background:#111827; color:#fff;
      padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      opacity:0; pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      font-size:14px; z-index:9999;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  </style>
</head>
<body>
<div class="app">
  <h1>L√§xkollen</h1>

  <!-- Barnv√§ljare -->
  <div class="topbar">
    <div>
      <select id="child-select" aria-label="V√§lj barn"></select>
    </div>
    <button id="manage-children" class="ghost">Hantera barn</button>
    <div class="spacer"></div>
  </div>

  <!-- Ny l√§xa/prov-knapp -->
  <div class="actions-row">
    <button id="add-quick" class="primary" aria-expanded="false" aria-controls="input-row">L√§gg till l√§xa/prov</button>
  </div>

  <!-- √ñversikt -->
  <div id="subject-summary" class="summary" aria-label="√ñversikt per √§mne"></div>

  <!-- Inmatning (g√∂md som default) -->
  <div id="input-row" class="row compact-gap" hidden>
    <div class="field">
      <label for="subject">√Ñmne</label>
      <select id="subject"></select>
    </div>

    <div class="field">
      <label for="task">L√§xa</label>
      <input id="task" type="text" placeholder="Beskriv l√§xan"/>
    </div>

    <div class="field prov">
      <label for="is-exam">Prov</label>
      <div class="checkline">
        <input id="is-exam" type="checkbox" />
      </div>
    </div>

    <div class="field">
      <label for="due">Datum</label>
      <input id="due" type="date"/>
    </div>

    <div class="field">
      <label for="times">Antal repitioner</label>
      <input id="times" type="number" min="1" value="1"/>
    </div>

    <div class="field" style="justify-content:flex-end;">
      <button id="add" class="primary" disabled aria-disabled="true">L√§gg till</button>
    </div>
  </div>

  <!-- Filter-rad -->
  <div class="row">
    <span class="chip active" data-filter="active">Kvar att g√∂ra</span>
    <span class="chip" data-filter="exam">Prov</span>
    <span class="chip" data-filter="done">Historik</span>

    <select id="filter-date" title="Filtrera datum"></select>
  </div>

  <div id="totals" class="totals" aria-live="polite">Totalt 0 l√§xor ‚Ä¢ Aktiva 0 ‚Ä¢ Klara 0</div>
  <ul id="list"></ul>
</div>

<!-- Modal: Hantera barn -->
<div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="manage-title">
  <div class="modal">
    <h2 id="manage-title">Hantera barn</h2>
    <div class="note" id="onboarding-note" style="display:none;">V√§lkommen! B√∂rja med att l√§gga till ett barn och v√§lja √§mnen. Du kan inte st√§nga f√∂rr√§n minst ett barn finns.</div>

    <!-- L√§gg till nytt barn (√∂verst) -->
    <div style="margin-top:10px;">
      <strong>L√§gg till nytt barn</strong>
      <div class="child-row">
        <input id="new-child-name" type="text" placeholder="Barnets namn" style="min-width:200px;">
        <div class="subjects-collection" id="new-child-subjects"></div>
        <button id="save-new-child" class="primary">L√§gg till barn</button>
      </div>

      <!-- √Ötg√§rdsknappar n√§ra add-sektionen -->
      <div class="modal-actions">
        <button id="cancel-modal" class="ghost">Avbryt</button>
        <button id="close-modal" class="primary">Spara och St√§ng</button>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">

    <!-- Aktuella barn (underst) -->
    <div>
      <strong>Aktuella barn</strong>
      <div id="children-list"></div>
    </div>
  </div>
</div>

<!-- Modal: Redigera l√§xa/prov -->
<div id="edit-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="edit-title">
  <div class="modal" style="max-width:640px">
    <h2 id="edit-title">Redigera</h2>
    <div class="row">
      <div class="field">
        <label for="edit-subject">√Ñmne</label>
        <select id="edit-subject"></select>
      </div>
      <div class="field">
        <label for="edit-task">L√§xa</label>
        <input id="edit-task" type="text" />
      </div>
    </div>
    <div class="row compact-gap">
      <div class="field prov">
        <label for="edit-is-exam">Prov</label>
        <div class="checkline">
          <input id="edit-is-exam" type="checkbox"/>
        </div>
      </div>
      <div class="field">
        <label for="edit-due">Datum</label>
        <input id="edit-due" type="date"/>
      </div>
      <div class="field">
        <label for="edit-times">Antal repitioner</label>
        <input id="edit-times" type="number" min="1" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="edit-cancel" class="ghost">Avbryt</button>
      <button id="edit-save" class="primary">Spara</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===== √Ñmnesgrupper + ikoner ===== */
const SUBJECT_GROUPS = [
  { title: "Spr√•k", items: ["Franska","Engelska","Spanska","Svenska","Italienska","Tyska"] },
  { title: "NO", items: ["Biologi","Fysik","Kemi","Naturkunskap","NO"] },
  { title: "SO", items: ["Geografi","Historia","Samh√§llskunskap","Religion","SO"] },
  { title: "Praktiskt-estetiska", items: ["Musik","Bild","Idrott & H√§lsa","Hemkunskap"] },
  { title: "√ñvrigt", items: ["Matte","Teknik"] },
  { title: "Gymnasie√§mnen", items: ["Juridik","F√∂retagsekonomi","Psykologi","Filosofi"] }
];
const ALL_SUBJECTS = SUBJECT_GROUPS.flatMap(g=>g.items);

const subjectIcons={
  "Franska":"üá´üá∑","Engelska":"üá¨üáß","Spanska":"üá™üá∏","Svenska":"üá∏üá™","Italienska":"üáÆüáπ","Tyska":"üá©üá™",
  "Biologi":"üß¨","Fysik":"‚öõÔ∏è","Kemi":"‚öóÔ∏è","Naturkunskap":"üåø","NO":"üî¨",
  "Geografi":"üó∫Ô∏è","Historia":"üìú","Samh√§llskunskap":"üèõÔ∏è","Religion":"‚õ™","SO":"üåç",
  "Musik":"üéµ","Bild":"üé®","Idrott & H√§lsa":"üèÉ‚Äç‚ôÇÔ∏è","Hemkunskap":"üç≥",
  "Matte":"‚ûó","Teknik":"‚öôÔ∏è",
  "Juridik":"‚öñÔ∏è","F√∂retagsekonomi":"üíº","Psykologi":"üß†","Filosofi":"ü§î"
};

const STORAGE_KEY="l√§xkollen-multi-children-v1";

/* ===== Store ===== */
let store = loadStore();
migrateStore();

/* ===== Modal-snapshot f√∂r Avbryt ===== */
let modalSnapshot = null;

/* ===== Element ===== */
const childSelect = document.getElementById("child-select");
const subjectSelect = document.getElementById("subject");
const taskInput = document.getElementById("task");
const dueInput = document.getElementById("due");
const timesInput = document.getElementById("times");
const isExamInput = document.getElementById("is-exam");

const addBtn = document.getElementById("add");
const addQuickBtn = document.getElementById("add-quick");
const inputRow = document.getElementById("input-row");

const chips = Array.from(document.querySelectorAll(".chip"));
const filterDate = document.getElementById("filter-date");

const subjectSummary = document.getElementById("subject-summary");
const totalsEl = document.getElementById("totals");
const listEl = document.getElementById("list");

/* Hantera barn modal */
const modalBackdrop = document.getElementById("modal-backdrop");
const manageBtn = document.getElementById("manage-children");
const childrenList = document.getElementById("children-list");
const newChildName = document.getElementById("new-child-name");
const newChildSubjects = document.getElementById("new-child-subjects");
const saveNewChildBtn = document.getElementById("save-new-child");
const closeModalBtn = document.getElementById("close-modal");
const cancelModalBtn = document.getElementById("cancel-modal");
const onboardingNote = document.getElementById("onboarding-note");

/* Redigera modal */
const editBackdrop = document.getElementById("edit-backdrop");
const editSubject = document.getElementById("edit-subject");
const editTask = document.getElementById("edit-task");
const editIsExam = document.getElementById("edit-is-exam");
const editDue = document.getElementById("edit-due");
const editTimes = document.getElementById("edit-times");
const editCancel = document.getElementById("edit-cancel");
const editSave = document.getElementById("edit-save");
let editingId = null;

/* ===== Init ===== */
renderAll();
ensureOnboarding();
toggleTimesForExam();
validateForm();

/* ===== Event listeners ===== */
addBtn.onclick = addHomework;

addQuickBtn.onclick = () => {
  if(!hasAnyChild()){ openModal(true); return; }
  toggleInputRow();
  validateForm();
};

document.addEventListener("keydown", (e)=>{
  const anyModalOpen = (modalBackdrop.style.display === "flex") || (editBackdrop.style.display === "flex");
  if(e.key === "Escape" && !anyModalOpen && !inputRow.hasAttribute("hidden")){
    abortInput();
  }
});

isExamInput.addEventListener("change", ()=>{ toggleTimesForExam(); validateForm(); });
subjectSelect.addEventListener("change", validateForm);
taskInput.addEventListener("input", validateForm);
dueInput.addEventListener("change", validateForm);

/* Edit modal interactions */
editIsExam.addEventListener("change", toggleEditTimesForExam);
editCancel.onclick = ()=>{ closeEditModal(); };
editSave.onclick = saveEditChanges;

/* Chip-klick: byt vy, nollst√§ll datumfiltret och bygg alternativ */
chips.forEach(c => c.onclick = () => {
  if(!hasAnyChild()){ openModal(true); return; }
  setActiveChip(c.dataset.filter);
  state().filter = c.dataset.filter; // 'active' | 'done' | 'exam'
  rebuildDateOptions();
  filterDate.value = "";
  renderAll();
  saveStore();
});

filterDate.onchange = ()=>{ renderList(); };

childSelect.onchange = () => {
  store.currentChild = childSelect.value;
  if(!store.currentChild){ return; }
  state().filter = "active";
  state().focusedSubject = "";
  setActiveChip("active");
  rebuildDateOptions();
  filterDate.value = "";
  saveStore();
  renderAll();
};

manageBtn.onclick = ()=>openModal(false);
closeModalBtn.onclick = ()=>{ if(hasAnyChild()) closeModal(); };
cancelModalBtn.onclick = ()=>{
  if(modalSnapshot){
    store = modalSnapshot;
    modalSnapshot = null;
    saveStore();
    renderAll();
    showToast("√Ñndringar √•ngrade");
  }
  modalBackdrop.style.display="none";
};
saveNewChildBtn.onclick = addNewChild;

/* ===== Logic ===== */
function hasAnyChild(){ return store.children && Object.keys(store.children).length>0; }
function ensureOnboarding(){ if(!hasAnyChild()) openModal(true); }

function state(){
  const name = store.currentChild;
  if(!name || !store.children || !store.children[name]){
    return { subjects:[], todos:[], filter:"active", focusedSubject:"" };
  }
  const s = store.children[name];
  if(!("filter" in s)) s.filter="active";
  if(!("focusedSubject" in s)) s.focusedSubject="";
  return s;
}

function addHomework(){
  if(!hasAnyChild()){ openModal(true); alert("L√§gg till ett barn f√∂rst."); return; }

  const s = state();
  const subj = subjectSelect.value;
  const task = taskInput.value.trim();
  const due  = dueInput.value;
  const isExam = !!isExamInput.checked;

  if(!due){
    alert(isExam ? "Ange datum f√∂r provet." : "Ange datum f√∂r l√§xan.");
    dueInput.focus();
    return;
  }

  const times = isExam ? 1 : (parseInt(timesInput.value) || 1);

  if(!s.subjects.includes(subj)){
    alert("√Ñmnet √§r inte aktivt f√∂r detta barn. L√§gg till √§mnet under 'Hantera barn'.");
    return;
  }
  if(!task) return;

  s.todos.push({ id:safeId(), subj, task, due, timesLeft:times, timesTotal:times, done:false, isExam, completedOn:null });
  saveStore();
  resetInputs();
  toggleTimesForExam();
  validateForm();

  if(!inputRow.hasAttribute("hidden")){
    inputRow.setAttribute("hidden", "");
    addQuickBtn.setAttribute("aria-expanded","false");
    addQuickBtn.textContent = "L√§gg till l√§xa/prov";
  }

  renderAll();
  showToast(isExam ? "Prov tillagt" : "L√§xa tillagd");
}

function tick(id){
  const s = state();
  const t = s.todos.find(x=>x.id===id);
  if(!t) return;

  if(t.isExam){ showToast("Prov f√∂rsvinner automatiskt efter provdatum"); return; }

  if(t.timesLeft > 1){
    t.timesLeft--;
    saveStore(); renderAll();
    const total = t.timesTotal || Math.max(1, t.timesLeft||1);
    const doneCount = Math.max(0, total - t.timesLeft);
    showToast(`Omg√•ng avklarad (${doneCount}/${total} gjorda)`);
  } else {
    t.timesLeft = 0;
    t.done = true;
    t.completedOn = todayLocalISO();
    saveStore(); renderAll();
    showToast("L√§xa klar!");
  }
}

function onCheckboxChange(id, isChecked){
  const s = state();
  const t = s.todos.find(x=>x.id===id);
  if(!t) return;

  if(t.isExam){ renderAll(); showToast("Prov bockas inte av manuellt"); return; }

  if(isChecked){
    if(!t.done){
      if(t.timesLeft > 1){
        t.timesLeft--;
        saveStore(); renderAll();
        const total = t.timesTotal || Math.max(1, t.timesLeft||1);
        const doneCount = Math.max(0, total - (t.timesLeft ?? total));
        showToast(`Omg√•ng avklarad (${doneCount}/${total} gjorda)`);
      } else {
        t.timesLeft = 0;
        t.done = true;
        t.completedOn = todayLocalISO();
        saveStore(); renderAll();
        showToast("L√§xa klar!");
      }
    }
  } else {
    if(t.done){
      t.done = false;
      t.completedOn = null;
      t.timesLeft = Math.max(1, t.timesLeft || 1);
      saveStore(); renderAll();
      showToast("Klarmarkering √•ngrad");
    }
  }
}

function removeItem(id){
  const s = state();
  const t = s.todos.find(x=>x.id===id);
  if(!t) return;
  const msg = t.isExam ? "√Ñr du s√§ker p√• att du vill radera detta prov?" :
                         "√Ñr du s√§ker p√• att du vill radera denna l√§xa?";
  if(!confirm(msg)) return;

  s.todos = s.todos.filter(x=>x.id!==id);
  saveStore(); 
  renderAll();
  showToast(t.isExam ? "Prov borttaget" : "L√§xa borttagen");
}

/* ====== EDIT ====== */
function openEditModal(id){
  const s = state();
  const t = s.todos.find(x=>x.id===id);
  if(!t) return;
  editingId = id;

  // Fyll √§mneslistan med barnets aktiva √§mnen
  editSubject.innerHTML = "";
  s.subjects.forEach(sub=>{
    const opt=document.createElement("option");
    opt.value=sub; opt.textContent=sub;
    editSubject.appendChild(opt);
  });

  editSubject.value = t.subj;
  editTask.value = t.task;
  editIsExam.checked = !!t.isExam;
  editDue.value = t.due || "";
  editTimes.value = t.timesTotal || Math.max(1, t.timesLeft || 1);

  toggleEditTimesForExam();
  editBackdrop.style.display="flex";
}

function toggleEditTimesForExam(){
  const isExam = !!editIsExam.checked;
  if(isExam){
    editTimes.value = "";
    editTimes.placeholder = "‚Äì";
    editTimes.disabled = true;
  } else {
    editTimes.disabled = false;
    editTimes.placeholder = "";
    if(!editTimes.value) editTimes.value = 1;
  }
}

function closeEditModal(){
  editingId = null;
  editBackdrop.style.display="none";
}

function saveEditChanges(){
  if(editingId==null) return;
  const s = state();
  const t = s.todos.find(x=>x.id===editingId);
  if(!t) return;

  const newSubj = editSubject.value;
  const newTask = editTask.value.trim();
  const newIsExam = !!editIsExam.checked;
  const newDue  = editDue.value;

  if(!newDue){
    alert(newIsExam ? "Ange datum f√∂r provet." : "Ange datum f√∂r l√§xan.");
    return;
  }
  if(!newTask){ alert("Beskriv l√§xan."); return; }
  if(!s.subjects.includes(newSubj)){
    alert("√Ñmnet √§r inte aktivt f√∂r detta barn.");
    return;
  }

  // Justera repetition & status
  if(newIsExam){
    t.timesTotal = 1;
    t.timesLeft  = t.done ? 0 : 1;
  } else {
    const oldTotal = t.timesTotal || Math.max(1, t.timesLeft || 1);
    const oldDoneCount = Math.max(0, oldTotal - (t.timesLeft ?? oldTotal));
    const newTotal = Math.max(1, parseInt(editTimes.value || "1"));
    let newLeft = Math.max(0, newTotal - oldDoneCount);

    if(t.done && newLeft>0){ t.done=false; t.completedOn=null; }
    if(!t.done && newLeft===0){ t.done=true; t.completedOn = t.completedOn || todayLocalISO(); }

    t.timesTotal = newTotal;
    t.timesLeft  = newLeft;
  }

  // Spara √∂vriga f√§lt
  t.subj = newSubj;
  t.task = newTask;
  t.isExam = newIsExam;
  t.due = newDue;

  saveStore();
  closeEditModal();
  renderAll();
  showToast("Uppgift uppdaterad");
}

/* ===== Autoklarmarkera prov efter datum ===== */
function finalizeExamsByDate(){
  const s = state();
  if(!s.todos) return;
  const today = todayLocalISO();
  let changed=false;
  s.todos.forEach(t=>{
    if(t.isExam && t.due && t.due < today && !t.done){
      t.done = true;
      t.completedOn = t.due;
      changed = true;
    }
  });
  if(changed) saveStore();
}

/* ===== Rendering ===== */
function renderAll(){
  finalizeExamsByDate();
  renderChildSelect();
  renderSubjectOptions();
  renderSummary();
  rebuildDateOptions();
  renderTotals();
  renderList();
}

function renderChildSelect(){
  childSelect.innerHTML = "";
  if(!hasAnyChild()){ childSelect.value=""; return; }
  Object.keys(store.children).sort().forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    childSelect.appendChild(opt);
  });
  if(!store.currentChild) store.currentChild = Object.keys(store.children)[0] || "";
  childSelect.value = store.currentChild || "";
}

function renderSubjectOptions(){
  const s = state();
  subjectSelect.innerHTML = "";
  if(s.subjects.length===0){
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="(L√§gg till barn & √§mnen via 'Hantera barn')";
    subjectSelect.appendChild(opt);
  } else {
    ALL_SUBJECTS.filter(sub=>s.subjects.includes(sub)).forEach(sub=>{
      const opt=document.createElement("option");
      opt.value=sub; opt.textContent=sub;
      subjectSelect.appendChild(opt);
    });
  }
}

function setActiveChip(filter){
  chips.forEach(x=>x.classList.remove("active"));
  const target = chips.find(x=>x.dataset.filter===filter);
  if(target) target.classList.add("active");
}

function renderSummary(){
  const s = state();
  const focused = s.focusedSubject || ""; // "" = Totalt
  const totalKvar = s.todos.filter(t=>!t.done).length;

  subjectSummary.innerHTML = "";

  const totalCard = document.createElement("div");
  totalCard.className = "card total-card";
  totalCard.title = "Visa aktiva l√§xor (alla √§mnen)";
  totalCard.setAttribute("role","button");
  totalCard.setAttribute("tabindex","0");
  totalCard.innerHTML = `
    <div class="title">üìä Totalt</div>
    <div class="kpi"><span class="pill ${focused===""?"active-pill":""}">Kvar: ${totalKvar}</span></div>
  `;
  if (focused==="") totalCard.classList.add("selected");

  const clearToActive = ()=>{
    s.filter = "active";
    s.focusedSubject = "";
    setActiveChip("active");
    filterDate.value = "";
    rebuildDateOptions();
    renderAll();
  };
  totalCard.onclick = clearToActive;
  totalCard.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); clearToActive(); } };
  subjectSummary.appendChild(totalCard);

  ALL_SUBJECTS.filter(sub=>s.subjects.includes(sub)).forEach(sub=>{
    const kvar  = s.todos.filter(t=>t.subj===sub && !t.done).length;

    const card=document.createElement("div");
    card.className="card";
    card.title=`Visa aktiva i ${sub}`;
    card.setAttribute("role","button");
    card.setAttribute("tabindex","0");

    const title=document.createElement("div");
    title.className="title";
    title.textContent=`${subjectIcons[sub]||"üìò"} ${sub}`;

    const kpi=document.createElement("div");
    kpi.className="kpi";
    const isSelected = (focused===sub);
    if (isSelected) card.classList.add("selected");
    kpi.innerHTML = `<span class="pill ${isSelected?"active-pill":""}">Kvar: ${kvar}</span>`;

    card.appendChild(title); 
    card.appendChild(kpi);

    const setFilterSubject = ()=>{
      s.filter = "active";
      s.focusedSubject = sub;
      setActiveChip("active");
      filterDate.value = "";
      rebuildDateOptions();
      renderAll();
    };
    card.onclick=setFilterSubject;
    card.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setFilterSubject(); } };

    subjectSummary.appendChild(card);
  });
}

function renderTotals(){
  const s = state();
  const total = s.todos.length;
  const active = s.todos.filter(t=>!t.done).length;
  const done = total - active;
  totalsEl.textContent = `Totalt ${total} ${plural(total,"l√§xa","l√§xor")} ‚Ä¢ Aktiva ${active} ‚Ä¢ Klara ${done}`;
}

function renderList(){
  const s = state();
  listEl.innerHTML = "";

  const viewFilter = s.filter || "active";
  const subjFocus = s.focusedSubject || "";
  const dateKey = filterDate.value || "";
  const todayISO = todayLocalISO();
  const today = isoToDate(todayISO);

  const items = s.todos.filter(t=>{
    if(subjFocus && t.subj !== subjFocus) return false;
    if(viewFilter==="active" && t.done) return false;
    if(viewFilter==="exam"   && (t.done || !t.isExam)) return false;
    if(viewFilter==="done"   && !t.done) return false;
    if(!matchesDateWindow(t, viewFilter, dateKey, today)) return false;
    return true;
  });

  if((s.filter||"active")==="done"){
    items.sort((a,b)=>{
      const ad = a.completedOn || a.due || "";
      const bd = b.completedOn || b.due || "";
      return bd.localeCompare(ad);
    });
  } else {
    const rank = (t) => {
      if (!t.due) return 3;
      if (!t.done && t.due < todayISO) return 0;
      if (!t.done && t.due === todayISO) return 1;
      return 2;
    };
    items.sort((a,b) => {
      const ra = rank(a), rb = rank(b);
      if (ra !== rb) return ra - rb;
      if (a.due && b.due) return a.due.localeCompare(b.due);
      return 0;
    });
  }

  items.forEach(t=>{
    const li=document.createElement("li");

    if(!t.done && t.due){
      if(t.due < todayISO) li.classList.add("overdue");
      else if(t.due === todayISO) li.classList.add("today");
    }
    if(t.done) li.classList.add("done");
    if(t.isExam) li.classList.add("exam");

    /* 1) Checkbox / ghost */
    if(!t.isExam){
      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=t.done;
      cb.title = t.done ? "Avmarkera som klar" : "Markera en omg√•ng klar (eller hela l√§xan)";
      cb.onchange=(e)=>onCheckboxChange(t.id, e.target.checked);
      li.appendChild(cb);
    } else {
      const ghost1 = document.createElement("div"); ghost1.className="ghost-cell"; li.appendChild(ghost1);
    }

    /* 2) Progress / ghost */
    if(!t.isExam && (t.timesTotal||1) > 1){
      const prog=document.createElement("span");
      const total = t.timesTotal || Math.max(1, t.timesLeft||1);
      const doneCount = Math.max(0, total - (t.timesLeft ?? total));
      prog.className="progress-badge";
      prog.textContent = `${doneCount}/${total} gjorda`;
      li.appendChild(prog);
    } else {
      const ghost2 = document.createElement("div"); ghost2.className="ghost-cell"; li.appendChild(ghost2);
    }

    /* 3) Text + meta */
    const textWrap=document.createElement("div");
    const text=document.createElement("div"); text.className="text";
    text.textContent=`${subjectIcons[t.subj]||"üìò"} ${t.subj}: ${t.task}`;

    const meta=document.createElement("div"); meta.className="meta-line";
    const dateNice = t.due ? formatDate(t.due) : "";
    const dueLabel = computeDueLabel(t, todayISO, dateNice);
    const dueClass  = computeDueClass(t, todayISO);
    meta.innerHTML = dueLabel ? `<span class="due-badge ${dueClass}">${dueLabel}</span>` : "";
    if(!t.isExam && (t.timesTotal||1) > 1){
      meta.innerHTML += ` ‚Ä¢ G√•ng kvar: ${t.timesLeft}`;
    }
    if(t.done && t.completedOn){
      meta.innerHTML += ` ‚Ä¢ Klar: ${formatDate(t.completedOn)}`;
    }
    textWrap.appendChild(text);
    textWrap.appendChild(meta);
    li.appendChild(textWrap);

    /* 4) Exam-badge */
    const examWrap = document.createElement("div");
    if(t.isExam){
      const examB = document.createElement("span");
      examB.className = "exam-badge";
      examB.textContent = "PROV";
      examWrap.appendChild(examB);
    }
    li.appendChild(examWrap);

    /* 5) Knappar: ‚úîÔ∏è (om l√§xa) ‚Ä¢ ‚öôÔ∏è ‚Ä¢ üóëÔ∏è */
    const btns=document.createElement("div");
    if(!t.isExam){
      const tickBtn=document.createElement("button"); 
      tickBtn.textContent="‚úîÔ∏è"; 
      tickBtn.className="icon-btn"; 
      tickBtn.title="Bocka av en omg√•ng"; 
      tickBtn.onclick=()=>tick(t.id);
      btns.appendChild(tickBtn);
    }

    const editBtn=document.createElement("button");
    editBtn.textContent="‚öôÔ∏è";
    editBtn.className="icon-btn";
    editBtn.title="Redigera";
    editBtn.onclick=()=>openEditModal(t.id);
    btns.appendChild(editBtn);

    const delBtn=document.createElement("button"); 
    delBtn.textContent="üóëÔ∏è"; 
    delBtn.className="icon-btn danger"; 
    delBtn.title=t.isExam?"Radera prov":"Radera l√§xa";
    delBtn.onclick=()=>removeItem(t.id);
    btns.appendChild(delBtn);

    li.appendChild(btns);
    listEl.appendChild(li);
  });
}

/* ===== Datum-filter ===== */
function rebuildDateOptions(){
  const view = state().filter || "active";
  filterDate.innerHTML = "";
  filterDate.appendChild(new Option("Alla datum",""));

  if(view === "done"){
    filterDate.appendChild(new Option("<2 veckor","lt2w"));
    filterDate.appendChild(new Option("<1 m√•nad","lt1m"));
  } else {
    filterDate.appendChild(new Option("<1 vecka","lt1w"));
    filterDate.appendChild(new Option("<2 veckor","lt2w"));
  }
}

/* ===== Datumhj√§lp ===== */
function todayLocalISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function isoToDate(iso){ return new Date(iso+"T00:00:00"); }

const MS_DAY = 24*60*60*1000;
function daysDiff(a, b){
  const a0 = new Date(a.getFullYear(), a.getMonth(), a.getDate());
  const b0 = new Date(b.getFullYear(), b.getMonth(), b.getDate());
  return Math.floor((a0.getTime() - b0.getTime())/MS_DAY);
}

function matchesDateWindow(t, viewFilter, key, today){
  if(key==="") return true;
  const due  = t.due ? isoToDate(t.due) : null;
  const comp = t.completedOn ? isoToDate(t.completedOn) : null;

  switch(key){
    case "lt1w": {
      if(viewFilter==="done") return true;
      if(!due) return false;
      const d = daysDiff(due, today);
      return d >= 0 && d <= 7;
    }
    case "lt2w": {
      if(viewFilter==="done"){
        if(!comp) return false;
        const d = daysDiff(today, comp);
        return d >= 0 && d <= 14;
      } else {
        if(!due) return false;
        const d = daysDiff(due, today);
        return d >= 0 && d <= 14;
      }
    }
    case "lt1m": {
      if(viewFilter!=="done" || !comp) return false;
      const d = daysDiff(today, comp);
      return d >= 0 && d <= 30;
    }
  }
  return true;
}

function computeDueLabel(t, todayISO, dateNice){
  if(!t.due) return "Ingen deadline";
  if(t.isExam && t.due < todayISO) return `Provdatum: ${dateNice}`;
  if(!t.done && t.due === todayISO) return "Idag";
  if(!t.done && t.due < todayISO) return "F√∂rsenad";
  return `Till: ${dateNice}`;
}
function computeDueClass(t, todayISO){
  if(!t.due) return "";
  if(t.isExam && t.due < todayISO) return "";
  if(!t.done && t.due === todayISO) return "today";
  if(!t.done && t.due < todayISO) return "overdue";
  return "";
}

/* ===== Modal Hantera Barn ===== */
function openModal(isOnboarding=false){
  try { modalSnapshot = JSON.parse(JSON.stringify(store)); } catch { modalSnapshot = null; }

  renderChildrenEditor();
  onboardingNote.style.display = (isOnboarding || !hasAnyChild()) ? "block" : "none";

  newChildName.value="";
  newChildSubjects.innerHTML="";
  buildSubjectsRows(newChildSubjects); // chips (allt ovalt som default)

  const lock = !hasAnyChild();
  closeModalBtn.disabled = lock;
  cancelModalBtn.disabled = lock;

  modalBackdrop.style.display="flex";
}

function closeModal(){
  if(!hasAnyChild()){ return; }

  // Samla val per barn fr√•n chips
  const selections = {};
  Object.keys(store.children).forEach(n=> selections[n]=[]);
  const activeChips = Array.from(document.querySelectorAll('#children-list .sub-chip.active[data-child]'));
  activeChips.forEach(btn=>{
    const nm = btn.dataset.child;
    (selections[nm] ||= []).push(btn.dataset.sub);
  });

  Object.entries(selections).forEach(([childName, subjects])=>{
    if (store.children[childName]) store.children[childName].subjects = subjects;
  });

  saveStore();
  renderAll();
  showToast("√Ñmnen sparade");

  modalSnapshot = null;
  modalBackdrop.style.display="none";
}

function renderChildrenEditor(){
  childrenList.innerHTML="";
  if(!hasAnyChild()) return;
  Object.entries(store.children).forEach(([name, obj])=>{
    const wrap=document.createElement("div"); wrap.className="child-row";

    const nameEl=document.createElement("div");
    nameEl.style.minWidth="140px";
    nameEl.innerHTML=`<strong>${name}</strong>`;

    const coll=document.createElement("div"); coll.className="subjects-collection";
    buildSubjectsRows(coll, obj.subjects, name);

    const actions=document.createElement("div");
    actions.style.display="flex"; actions.style.gap="8px"; actions.style.alignItems="center";

    const delBtn=document.createElement("button");
    delBtn.className="ghost danger-text";
    delBtn.textContent="Ta bort barn";
    delBtn.title="Tar bort barnet och alla dess l√§xor";
    delBtn.onclick=()=>deleteChild(name);

    actions.appendChild(delBtn);

    wrap.appendChild(nameEl); 
    wrap.appendChild(coll); 
    wrap.appendChild(actions);
    childrenList.appendChild(wrap);
  });
}

/* Bygg grupper: varje grupp = rubrik + 1 rad chips (sm√• toggle-knappar) */
function buildSubjectsRows(container, preselected=[], childName=null){
  SUBJECT_GROUPS.forEach(group=>{
    const gwrap=document.createElement("div"); gwrap.className="subjects-group";

    const header=document.createElement("div");
    header.className="group-header";
    header.textContent = group.title;

    const row=document.createElement("div");
    row.className="subject-row";

    group.items.forEach(sub=>{
      const btn=document.createElement("button");
      btn.type="button";
      btn.className="sub-chip";
      btn.dataset.sub = sub;
      if(childName) btn.dataset.child = childName;
      const selected = !!(preselected && preselected.includes(sub));
      if(selected) btn.classList.add("active");
      btn.setAttribute("aria-pressed", selected ? "true" : "false");
      btn.textContent = `${subjectIcons[sub]||"üìò"} ${sub}`;
      btn.onclick = ()=>{
        const newState = !btn.classList.contains("active");
        btn.classList.toggle("active", newState);
        btn.setAttribute("aria-pressed", newState ? "true" : "false");
      };
      row.appendChild(btn);
    });

    gwrap.appendChild(header);
    gwrap.appendChild(row);
    container.appendChild(gwrap);
  });
}

function addNewChild(){
  const name = newChildName.value.trim();
  if(!name){ alert("Ange ett namn."); return; }
  if(store.children && store.children[name]){ alert("Det finns redan ett barn med det namnet."); return; }

  const subjects = Array.from(newChildSubjects.querySelectorAll('.sub-chip.active')).map(b=>b.dataset.sub);
  if(!store.children) store.children = {};
  store.children[name] = { subjects, todos:[], filter:"active", focusedSubject:"" };

  store.currentChild = name;
  saveStore();
  renderAll();
  renderChildrenEditor();

  closeModalBtn.disabled = false;
  cancelModalBtn.disabled = false;

  showToast(`Lade till ${name}`);

  // L√•t dialogen vara kvar s√• man kan l√§gga till fler barn
  newChildName.value = "";
  newChildSubjects.innerHTML = "";
  buildSubjectsRows(newChildSubjects);
}

function deleteChild(name){
  if(!confirm(`Vill du ta bort ${name}? Detta tar bort alla l√§xor f√∂r barnet.`)) return;
  if(store.children) delete store.children[name];
  const names = store.children ? Object.keys(store.children) : [];
  if(names.length===0){
    store.currentChild = "";
    if (modalBackdrop.style.display === "flex"){
      closeModalBtn.disabled = true;
      cancelModalBtn.disabled = true;
    }
  } else {
    store.currentChild = names[0];
  }
  saveStore();
  renderAll(); renderChildrenEditor();
}

/* ===== Helpers ===== */
function toggleInputRow(){
  const isHidden = inputRow.hasAttribute("hidden");
  if(isHidden){
    inputRow.removeAttribute("hidden");
    addQuickBtn.setAttribute("aria-expanded","true");
    addQuickBtn.textContent = "St√§ng";
    setTimeout(()=> taskInput.focus(), 0);
  } else {
    abortInput();
  }
}
function abortInput(){
  resetInputs();
  toggleTimesForExam();
  validateForm();
  inputRow.setAttribute("hidden", "");
  addQuickBtn.setAttribute("aria-expanded","false");
  addQuickBtn.textContent = "L√§gg till l√§xa/prov";
}

function toggleTimesForExam(){
  const isExam = !!isExamInput.checked;
  if(isExam){
    timesInput.value = "";
    timesInput.placeholder = "‚Äì";
    timesInput.disabled = true;
  } else {
    timesInput.disabled = false;
    timesInput.placeholder = "";
    if(!timesInput.value) timesInput.value = 1;
  }
}

function validateForm(){
  const subjOk = !!subjectSelect.value;
  const taskOk = taskInput.value.trim().length > 0;
  const dueOk  = !!dueInput.value;
  const ok = subjOk && taskOk && dueOk;
  addBtn.disabled = !ok;
  addBtn.setAttribute("aria-disabled", String(!ok));
}

function migrateStore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(!parsed.children) return;
    Object.values(parsed.children).forEach(c=>{
      (c.todos||[]).forEach(t=>{
        if(typeof t.timesTotal!=="number" || t.timesTotal<1){
          t.timesTotal = Math.max(1, t.timesLeft || 1);
        }
        if(t.timesLeft>t.timesTotal){ t.timesLeft = t.timesTotal; }
        if(t.isExam && t.due && t.done && !t.completedOn){
          t.completedOn = t.due;
        }
        if(t.done && !t.completedOn){
          t.completedOn = null;
        }
      });
    });
    store = parsed;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
  }catch{}
}
function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }
function loadStore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { currentChild:"", children:{} };
    const parsed = JSON.parse(raw);
    if(!parsed.children) parsed.children = {};
    return parsed;
  }catch{ return { currentChild:"", children:{} }; }
}
function safeId(){ return "id-"+Math.random().toString(36).slice(2,10); }
function resetInputs(){ taskInput.value=""; dueInput.value=""; timesInput.value=1; isExamInput.checked=false; }
function formatDate(d){ try{ const [y,m,dd]=d.split("-"); return `${dd}/${m}/${y}`; } catch { return d; } }
function plural(n, one, many){ return n===1 ? one : many; }
let _toastTimer;
function showToast(msg, ms=1800){
  const el = document.getElementById('toast');
  if(!el) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(()=> el.classList.remove('show'), ms);
}

/* ===== PWA: registrera service worker ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
